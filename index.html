<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Previs√£o do tempo</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: #f0f0f0;
  }

  h1 {
    margin-bottom: 16px;
  }

  select, button {
    margin-right: 8px;
    padding: 6px 10px;
    font-size: 14px;
  }

  #cards-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 16px;
  }

  .card {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 12px;
    background: #f5f5f5;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    width: fit-content;
    min-width: 240px;
    max-width: 100%;
  }

  .day-title {
    font-weight: bold;
    margin-bottom: 6px;
    text-align: center;
  }

  .hours {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .hour {
    padding: 6px 10px;
    border-radius: 6px;
    color: #333;
    font-size: 14px;
    cursor: default;
    transition: transform 0.1s;
    position: relative;
    min-width: 120px;
  }

  .hour:hover {
    transform: scale(1.05);
    z-index: 1;
  }

  /* cores suaves conforme clima */
  .hour.sun { background: #FFF7C2; }      
  .hour.clouds { background: #E0E0E0; }   
  .hour.rain { background: #C8E4FF; }     
  .hour.storm { background: #D8C8FF; }    

  /* tooltip estilizado */
  .tooltip {
    visibility: hidden;
    opacity: 0;
    position: absolute;
    left: 105%;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0,0,0,0.9);
    color: #fff;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 12px;
    white-space: nowrap;
    transition: opacity 0.2s;
    pointer-events: none;
    z-index: 10;
  }

  .hour:hover .tooltip {
    visibility: visible;
    opacity: 1;
  }

  @media (max-width: 500px) {
    .hour {
      min-width: 100px;
      font-size: 13px;
    }
  }
</style>
</head>
<body>

<h1 id="title">Previs√£o do tempo</h1>

<select id="estado-select">
  <option value="">Selecione o estado</option>
</select>

<select id="municipio-select">
  <option value="">Selecione o munic√≠pio</option>
</select>

<button id="consultar-btn">Consultar</button>

<div id="cards-container"></div>

<script>
const backendUrl = "https://weather-backend-hh3w.onrender.com/forecast";

async function carregarEstados() {
  const res = await fetch("https://servicodados.ibge.gov.br/api/v1/localidades/estados?orderBy=nome");
  const estados = await res.json();
  const select = document.getElementById("estado-select");
  estados.forEach(e => {
    const option = document.createElement("option");
    option.value = e.id;
    option.textContent = e.nome;
    select.appendChild(option);
  });
}

async function carregarMunicipios(estadoId) {
  const res = await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${estadoId}/municipios`);
  const municipios = await res.json();
  const select = document.getElementById("municipio-select");
  select.innerHTML = '<option value="">Selecione o munic√≠pio</option>';
  municipios.forEach(m => {
    const option = document.createElement("option");
    option.value = m.nome;
    option.textContent = m.nome;
    select.appendChild(option);
  });
}

function agruparPorDia(lista) {
  const dias = {};
  lista.forEach(item => {
    const dia = item.dt_txt.split(" ")[0];
    if (!dias[dia]) dias[dia] = [];
    dias[dia].push(item);
  });
  return dias;
}

function mapIconToClass(main) {
  main = main.toLowerCase();
  if (main.includes("rain")) return "rain";
  if (main.includes("storm") || main.includes("thunder")) return "storm";
  if (main.includes("cloud")) return "clouds";
  if (main.includes("clear") || main.includes("sun")) return "sun";
  return "clouds";
}

function mapIconToEmoji(main) {
  main = main.toLowerCase();
  if (main.includes("rain")) return "üåßÔ∏è";
  if (main.includes("storm") || main.includes("thunder")) return "‚õàÔ∏è";
  if (main.includes("cloud")) return "‚òÅÔ∏è";
  if (main.includes("clear") || main.includes("sun")) return "‚òÄÔ∏è";
  return "üå§Ô∏è";
}

function formatarData(dia) {
  const dateObj = new Date(dia);
  const diasSemana = ["domingo","segunda-feira","ter√ßa-feira","quarta-feira","quinta-feira","sexta-feira","s√°bado"];
  const diaSemana = diasSemana[dateObj.getDay()];
  const diaNum = String(dateObj.getDate()).padStart(2,"0");
  const mes = String(dateObj.getMonth()+1).padStart(2,"0");
  return `${diaNum}/${mes} ${diaSemana}`;
}

function gerarCards(previsao, cidade) {
  const container = document.getElementById("cards-container");
  container.innerHTML = "";
  document.getElementById("title").textContent = `Previs√£o do tempo para ${cidade}`;

  const dias = Object.entries(agruparPorDia(previsao.list));
  const diasParaMostrar = dias.slice(0,4); // hoje + 3 dias

  diasParaMostrar.forEach(([dia, horarios]) => {
    const card = document.createElement("div");
    card.className = "card";

    const diaTitle = document.createElement("div");
    diaTitle.className = "day-title";
    diaTitle.textContent = formatarData(dia);
    card.appendChild(diaTitle);

    const horasContainer = document.createElement("div");
    horasContainer.className = "hours";

    const horariosDesejados = ["00:00:00","06:00:00","12:00:00","18:00:00","21:00:00"];
    horariosDesejados.forEach(horaStr => {
      const item = horarios.find(h => h.dt_txt.includes(horaStr));
      if(item){
        const hourDiv = document.createElement("div");
        hourDiv.className = "hour " + mapIconToClass(item.weather[0].main);

        const emoji = mapIconToEmoji(item.weather[0].main);

        // hora + temperatura + √≠cone + descri√ß√£o
        const horaTxt = item.dt_txt.split(" ")[1].slice(0,5);
        hourDiv.textContent = `${horaTxt} - ${item.main.temp.toFixed(0)}¬∞C ${emoji} ${item.weather[0].description}`;

        // tooltip: sensa√ß√£o + umidade + vento
        const tooltip = document.createElement("div");
        tooltip.className = "tooltip";
        tooltip.innerHTML = `
          Sensa√ß√£o: ${item.main.feels_like.toFixed(0)}¬∞C<br>
          Umidade: ${item.main.humidity}%<br>
          Vento: ${item.wind.speed} m/s
        `;
        hourDiv.appendChild(tooltip);

        horasContainer.appendChild(hourDiv);
      }
    });

    card.appendChild(horasContainer);
    container.appendChild(card);
  });
}

document.getElementById("estado-select").addEventListener("change", (e)=>{
  carregarMunicipios(e.target.value);
});

document.getElementById("consultar-btn").addEventListener("click", async ()=>{
  const cidade = document.getElementById("municipio-select").value;
  if(!cidade) return alert("Selecione um munic√≠pio!");
  const res = await fetch(`${backendUrl}?city=${cidade}`);
  const data = await res.json();
  gerarCards(data, cidade);
});

carregarEstados();
</script>

</body>
</html>
