<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Previsão do Tempo</title>
  <style>
    /* =================== Global =================== */
    body { 
      font-family: 'Inter', Arial, sans-serif; 
      margin: 0; 
      padding: 0; 
      transition: background 0.5s ease; 
    }
    h1 { text-align: center; margin: 20px; color: #222; }

    /* =================== Cards =================== */
    .container { 
      display: flex; 
      flex-wrap: wrap; 
      justify-content: center; 
      gap: 20px; 
      padding: 20px; 
    }
    .card { 
      background: rgba(255,255,255,0.85); 
      border-radius: 20px; 
      padding: 20px; 
      box-shadow: 0 8px 20px rgba(0,0,0,0.15); 
      width: 240px; 
      transition: transform 0.3s ease, box-shadow 0.3s ease; 
      cursor: pointer; 
      backdrop-filter: blur(6px);
    }
    .card:hover { 
      transform: translateY(-8px); 
      box-shadow: 0 12px 28px rgba(0,0,0,0.25); 
    }
    .card h2 { text-align: center; margin: 0 0 12px; color: #333; }
    .horarios { display: flex; justify-content: space-around; }
    .horario { text-align: center; position: relative; }
    .horario img { width: 48px; height: 48px; margin-bottom: 6px; }
    .tooltip { 
      visibility: hidden; 
      background-color: rgba(0,0,0,0.8); 
      color: #fff; 
      text-align: center; 
      border-radius: 6px; 
      padding: 6px; 
      position: absolute; 
      z-index: 1; 
      bottom: 125%; 
      left: 50%; 
      transform: translateX(-50%); 
      opacity: 0; 
      transition: opacity 0.3s; 
      font-size: 12px;
      width: max-content;
      max-width: 180px;
    }
    .horario:hover .tooltip { visibility: visible; opacity: 1; }

    /* =================== Responsividade =================== */
    @media (max-width: 600px) {
      .container { flex-direction: column; align-items: center; }
      .card { width: 90%; }
      .horarios { flex-direction: column; gap: 10px; }
      .horario { display: flex; align-items: center; gap: 10px; }
      .horario img { width: 36px; height: 36px; }
      .tooltip { font-size: 11px; }
    }
  </style>
</head>
<body>
  <h1>Previsão do Tempo</h1>
  <div class="container" id="container"></div>

  <script>
    const container = document.getElementById("container");

    async function fetchWeather() {
      try {
        const resp = await fetch("https://weather-backend-hh3w.onrender.com/forecast");
        const dados = await resp.json();
        processarPrevisao(dados);
      } catch (err) {
        console.error("Erro ao buscar previsão:", err);
        container.innerHTML = "<p>Erro ao carregar previsão.</p>";
      }
    }

    function processarPrevisao(dados) {
      const diasMap = new Map();
      const agora = new Date();

      dados.list.forEach(item => {
        const data = new Date(item.dt * 1000);
        const horaLocal = parseInt(new Intl.DateTimeFormat("pt-BR", {
          timeZone: "America/Sao_Paulo",
          hour: "numeric", hour12: false
        }).format(data));

        const dia = new Intl.DateTimeFormat("pt-BR", {
          timeZone: "America/Sao_Paulo",
          day: "2-digit", month: "2-digit", year: "numeric"
        }).format(data);

        const isHoje = data.getDate() === agora.getDate();

        // --- Mantém só os horários de interesse ---
        if ([6, 12, 18, 21, 0, 3].includes(horaLocal)) {
          // Descarta horários passados (exceto exceções)
          if (isHoje) {
            if (horaLocal < agora.getHours()) {
              // ✅ Exceção: manter o 18h mesmo que já sejam 18–20h59
              if (!(agora.getHours() >= 18 && agora.getHours() < 21 && horaLocal === 18)) {
                return; 
              }
            }
          }

          if (!diasMap.has(dia)) {
            diasMap.set(dia, { horarios: [] });
          }

          diasMap.get(dia).horarios.push({
            hora: horaLocal,
            desc: item.weather[0].description,
            temp: Math.round(item.main.temp),
            feels_like: Math.round(item.main.feels_like),
            humidity: item.main.humidity,
            pop: Math.round((item.pop || 0) * 100),
            icon: item.weather[0].icon
          });
        }
      });

      // --- Ajuste especial para hoje ---
      const hojeStr = new Intl.DateTimeFormat("pt-BR", {
        timeZone: "America/Sao_Paulo",
        day: "2-digit", month: "2-digit", year: "numeric"
      }).format(agora);

      if (diasMap.has(hojeStr)) {
        const hojeData = diasMap.get(hojeStr);
        const amanha = new Date(agora);
        amanha.setDate(agora.getDate() + 1);
        const amanhaStr = new Intl.DateTimeFormat("pt-BR", {
          timeZone: "America/Sao_Paulo",
          day: "2-digit", month: "2-digit", year: "numeric"
        }).format(amanha);

        if (agora.getHours() >= 15 && agora.getHours() < 21) {
          adicionarHoraAmanha(dados, amanhaStr, hojeData, [0]);
        }
        if (agora.getHours() >= 21) {
          adicionarHoraAmanha(dados, amanhaStr, hojeData, [0, 3]);
        }
      }

      renderizarPrevisao(diasMap);
    }

    function adicionarHoraAmanha(dados, amanhaStr, hojeData, horas) {
      horas.forEach(hora => {
        const previsaoReal = dados.list.find(item => {
          const data = new Date(item.dt * 1000);
          const dataStr = new Intl.DateTimeFormat("pt-BR", {
            timeZone: "America/Sao_Paulo",
            day: "2-digit", month: "2-digit", year: "numeric"
          }).format(data);
          const horaLocal = parseInt(new Intl.DateTimeFormat("pt-BR", {
            timeZone: "America/Sao_Paulo",
            hour: "numeric", hour12: false
          }).format(data));
          return dataStr === amanhaStr && horaLocal === hora;
        });
        if (previsaoReal) {
          hojeData.horarios.push({
            hora,
            desc: previsaoReal.weather[0].description,
            temp: Math.round(previsaoReal.main.temp),
            feels_like: Math.round(previsaoReal.main.feels_like),
            humidity: previsaoReal.main.humidity,
            pop: Math.round((previsaoReal.pop || 0) * 100),
            icon: previsaoReal.weather[0].icon,
            fromTomorrow: true
          });
        }
      });
    }

    function renderizarPrevisao(diasMap) {
      container.innerHTML = "";
      diasMap.forEach((dadosDia, dia) => {
        const card = document.createElement("div");
        card.className = "card";

        const titulo = document.createElement("h2");
        const dataObj = new Date(dia.split("/").reverse().join("-"));
        const hoje = new Date();
        let tituloTexto = dataObj.toDateString() === hoje.toDateString() ? "Hoje" :
                          dataObj.toDateString() === new Date(hoje.setDate(hoje.getDate() + 1)).toDateString() ? "Amanhã" :
                          dia;
        titulo.textContent = tituloTexto;
        card.appendChild(titulo);

        const horariosDiv = document.createElement("div");
        horariosDiv.className = "horarios";

        dadosDia.horarios.slice(0,3).forEach(h => {
          const horarioDiv = document.createElement("div");
          horarioDiv.className = "horario";
          const horaStr = h.hora.toString().padStart(2,"0")+":00";
          horarioDiv.innerHTML = `
            <div>${horaStr}</div>
            <img src="https://openweathermap.org/img/wn/${h.icon}@2x.png" alt="${h.desc}">
            <div>${h.temp}°C</div>
            <div class="tooltip">
              ${h.desc}<br>
              Sensação: ${h.feels_like}°C<br>
              Umidade: ${h.humidity}%<br>
              Chuva: ${h.pop}%
            </div>`;
          horariosDiv.appendChild(horarioDiv);
        });

        card.appendChild(horariosDiv);
        container.appendChild(card);
      });
    }

    fetchWeather();
  </script>
</body>
</html>
