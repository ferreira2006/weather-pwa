<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Previsão do tempo</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: #f0f0f0;
  }

  h1 {
    margin-bottom: 16px;
  }

  select, button {
    margin-right: 8px;
    padding: 6px 10px;
    font-size: 14px;
  }

  #cards-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 16px;
  }

  .card {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 10px;
    background: #f5f5f5;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    width: fit-content;
    min-width: 220px;
  }

  .day-title {
    font-weight: bold;
    margin-bottom: 6px;
  }

  .hours {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .hour {
    position: relative;
    padding: 6px 10px;
    border-radius: 6px;
    color: #333;
    font-size: 14px;
    cursor: default;
    transition: transform 0.1s;
    width: fit-content;
  }

  .hour:hover {
    transform: scale(1.05);
    z-index: 2;
  }

  /* cores suaves */
  .hour.sun { background: #FFF8C2; }      /* amarelo pastel para sol */
  .hour.clouds { background: #E0E0E0; }   /* cinza claro para nublado */
  .hour.rain { background: #C7E2FF; }     /* azul pastel para chuva */
  .hour.storm { background: #D9C7FF; }    /* lilás claro para tempestade */

  /* ===== TOOLTIP ESTILIZADO ===== */
  .tooltip {
    display: none;
    position: absolute;
    left: 105%;
    top: 50%;
    transform: translateY(-50%);
    background: #333;
    color: #fff;
    font-size: 13px;
    line-height: 1.4em;
    padding: 8px 10px;
    border-radius: 6px;
    white-space: pre-line;
    max-width: 220px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }

  .hour:hover .tooltip {
    display: block;
  }

  .tooltip::after {
    content: "";
    position: absolute;
    left: -6px;
    top: 50%;
    transform: translateY(-50%);
    border-width: 6px;
    border-style: solid;
    border-color: transparent #333 transparent transparent;
  }
</style>
</head>
<body>

<h1 id="title">Previsão do tempo</h1>

<select id="estado-select">
  <option value="">Selecione o estado</option>
</select>

<select id="municipio-select">
  <option value="">Selecione o município</option>
</select>

<button id="consultar-btn">Consultar</button>

<div id="cards-container"></div>

<script>
const backendUrl = "https://weather-backend-hh3w.onrender.com/forecast";

async function carregarEstados() {
  const res = await fetch("https://servicodados.ibge.gov.br/api/v1/localidades/estados?orderBy=nome");
  const estados = await res.json();
  const select = document.getElementById("estado-select");
  estados.forEach(e => {
    const option = document.createElement("option");
    option.value = e.id;
    option.textContent = e.nome;
    select.appendChild(option);
  });
}

async function carregarMunicipios(estadoId) {
  const res = await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${estadoId}/municipios`);
  const municipios = await res.json();
  const select = document.getElementById("municipio-select");
  select.innerHTML = '<option value="">Selecione o município</option>';
  municipios.forEach(m => {
    const option = document.createElement("option");
    option.value = m.nome;
    option.textContent = m.nome;
    select.appendChild(option);
  });
}

function agruparPorDia(lista) {
  const dias = {};
  lista.forEach(item => {
    const dia = item.dt_txt.split(" ")[0];
    if (!dias[dia]) dias[dia] = [];
    dias[dia].push(item);
  });
  return dias;
}

function mapIconToClass(main) {
  main = main.toLowerCase();
  if (main.includes("rain")) return "rain";
  if (main.includes("storm") || main.includes("thunder")) return "storm";
  if (main.includes("cloud")) return "clouds";
  if (main.includes("clear") || main.includes("sun")) return "sun";
  return "clouds";
}

function gerarCards(previsao, cidade) {
  const container = document.getElementById("cards-container");
  container.innerHTML = "";
  document.getElementById("title").textContent = `Previsão do tempo para ${cidade}`;

  const dias = Object.entries(agruparPorDia(previsao.list));
  const diasParaMostrar = dias.slice(0,4); // hoje + 3 dias

  diasParaMostrar.forEach(([dia, horarios]) => {
    const card = document.createElement("div");
    card.className = "card";

    const diaTitle = document.createElement("div");
    diaTitle.className = "day-title";
    diaTitle.textContent = dia;
    card.appendChild(diaTitle);

    const horasContainer = document.createElement("div");
    horasContainer.className = "hours";

    const horariosDesejados = ["00:00:00","06:00:00","12:00:00","18:00:00","21:00:00"];
    horariosDesejados.forEach(horaStr => {
      const item = horarios.find(h => h.dt_txt.includes(horaStr));
      if(item){
        const hourDiv = document.createElement("div");
        hourDiv.className = "hour " + mapIconToClass(item.weather[0].main);
        hourDiv.textContent = `${item.dt_txt.split(" ")[1].slice(0,5)} - ${item.weather[0].description}`;

        // tooltip customizado
        const tooltip = document.createElement("div");
        tooltip.className = "tooltip";
        tooltip.textContent = 
`Temp: ${item.main.temp}°C
Sensação: ${item.main.feels_like}°C
Mín: ${item.main.temp_min}°C
Máx: ${item.main.temp_max}°C
Umidade: ${item.main.humidity}%
Vento: ${item.wind.speed} m/s`;

        hourDiv.appendChild(tooltip);
        horasContainer.appendChild(hourDiv);
      }
    });

    card.appendChild(horasContainer);
    container.appendChild(card);
  });
}

document.getElementById("estado-select").addEventListener("change", (e)=>{
  carregarMunicipios(e.target.value);
});

document.getElementById("consultar-btn").addEventListener("click", async ()=>{
  const cidade = document.getElementById("municipio-select").value;
  if(!cidade) return alert("Selecione um município!");
  const res = await fetch(`${backendUrl}?city=${cidade}`);
  const data = await res.json();
  gerarCards(data, cidade);
});

carregarEstados();
</script>

</body>
</html>
